## 原始流程
先验城市分析 =》 后验城市选择

问题1. 先验和后验两部分均基于规则，效果不好并且可维护性差。
问题2. 原始的城市分析仅用query级的特征，包括点击，session改写，query和城市共现，对于低频query处理的不好

## 城市分析
### 新的流程
1.城市分析是一个轻召回重排序的问题，我们将城市分析设计为召回和排序的两阶段任务
2.召回阶段，我们主要从query和phrase两种粒度挖掘特征资源，而后进行候选城市归并。
3.排序阶段，需要对候选城市进行判断，识别是否应为目标城市，用gbdt进行二分类进行拟合

### 样本构建
样本方面，我们选择从搜索日志中随机抽取，简单清洗后，进行人工标注。构造样本时存在本异地分样本分布不均的问题，本地需求远远多于异地，这里需要剔除本地和异地相关的特征，避免模型学偏。


### 特征体系
query级特征：如用户在特定query&city下的点击；
phrase级特征：类比于query级的特征，在更细粒度下进行统计；
组合特征：为了克服单一特征表征能力不足的问题，这里我们进行了一些人工特征组合。


## 城市选择
先进行城市内部意图比拼，在进行城市间意图比拼

### 样本构建：
使用随机query的多个城市意图结果作为样本，正样本为点击样本，其他城市都是负样本，然后采用pair-wise进行正样本和负样本对比

### 特征构建：
1. 先验特征：如城市分析部分输出的置信度
2. 文本特征：一些基础的文本相关性特征
3. 点击特征：如不同意图城市中的点击强度
4. 意图特征：一些特征可能影响用户的城市倾向，如用户位置与首位POI距离。

相比原始的城市分析和城市选择，两个模块全部实现机器学习化，在恶劣badcase显著降低的同时，可维护性大幅提高。在后续的建模中，我们将城市分析作为一个上层应用任务，通过多任务的方式接入到query分析的统一模型中来，降低了特征间的耦合，同时实现进一步的效果提升。
